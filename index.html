<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI EKG Asistanƒ±</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel (JSX Derleyicisi) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Markdown Renderer (AI yanƒ±tlarƒ±nƒ± g√ºzel g√∂stermek i√ßin) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Import Map: React ve Firebase Mod√ºlleri -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
            "firebase/analytics": "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js"
        }
    }
    </script>

    <style>
        /* Medikal Tema ve Animasyonlar */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        .pulse-red { animation: pulseRed 2s infinite; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        /* Markdown Stilleri */
        .prose h1, .prose h2, .prose h3 { color: #e2e8f0; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose strong { color: #34d399; }
        .prose p { margin-bottom: 0.8em; line-height: 1.6; }
        .warning-block { border-left: 4px solid #ef4444; background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen selection:bg-red-500 selection:text-white">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, getDoc } from 'firebase/firestore';
        import { getAnalytics } from "firebase/analytics";

        // --- ƒ∞konlar (Lucide SVG'leri - Medikal Odaklƒ±) ---
        const Icons = {
            HeartPulse: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/><path d="M3.22 12H9.5l.5-1 2 4.5 2-7 1.5 3.5h5.27"/></svg>,
            Activity: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            BrainCircuit: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/><path d="M17.599 6.5a3 3 0 0 0 .399-1.375"/><path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"/><path d="M3.477 10.896a4 4 0 0 1 .585-.396"/><path d="M19.938 10.5a4 4 0 0 1 .585.396"/><path d="M6 18a4 4 0 0 1-1.97-1.364"/><path d="M19.97 16.636A4 4 0 0 1 18 18"/></svg>,
            Camera: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            Monitor: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></svg>,
            X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Check: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            AlertTriangle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
            Copy: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
        };

        // =================================================================================
        // FIREBASE AYARLARI
        // =================================================================================
        
        let firebaseConfig;
        let appId;

        // 1. √ñNƒ∞ZLEME MODU (Burada otomatik √ßalƒ±≈üƒ±r)
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        } 
        // 2. YAYINLAMA / LOCALHOST MODU (ƒ∞ndirdiƒüiniz dosya i√ßin burayƒ± doldurun!)
        else {
            // Dƒ∞KKAT: Dosyayƒ± indirip √ßalƒ±≈ütƒ±rƒ±yorsanƒ±z buradaki bilgileri
            // kendi Firebase proje bilgilerinizle deƒüi≈ütirmelisiniz!
            firebaseConfig = {
                apiKey: "AIzaSyAfxpTsjdflSCFcxPrTFlpu-OR4mFSmW00",
                authDomain: "transfer-864ec.firebaseapp.com",
                projectId: "transfer-864ec",
                storageBucket: "transfer-864ec.firebasestorage.app",
                messagingSenderId: "153510424736",
                appId: "1:153510424736:web:fc2b3a85f28cbc0895d9c5",
                measurementId: "G-X0NTS1FE5T"
            };
            appId = "transfer-864ec"; 
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        try { if (typeof getAnalytics === 'function') getAnalytics(app); } catch(e) {}

        // --- Yardƒ±mcƒ± Fonksiyonlar ---
        const generateRoomCode = () => Math.floor(100000 + Math.random() * 900000).toString();

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        const maxSize = 1024; // EKG i√ßin biraz daha y√ºksek √ß√∂z√ºn√ºrl√ºk

                        if (width > height) {
                            if (width > maxSize) { height *= maxSize / width; width = maxSize; }
                        } else {
                            if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        };

        // --- GEMINI AI ANALƒ∞Z FONKSƒ∞YONU ---
        const analyzeECGWithGemini = async (base64Image, apiKey) => {
            if (!apiKey) throw new Error("Gemini API Anahtarƒ± eksik.");

            const prompt = `
Sen uzman bir Acil Tƒ±p Hekimi ve Kardiyologsun. 
G√∂revin: Sana verilen EKG (Elektrokardiyografi) g√∂r√ºnt√ºs√ºn√º acil servis ≈üartlarƒ±nda analiz etmek.
Analizi ≈üu ba≈ülƒ±klar altƒ±nda T√ºrk√ße olarak yap:

1. **Ritim ve Hƒ±z:** (Sin√ºs ritmi mi? Ta≈üikardi/Bradikardi var mƒ±? Hƒ±z ka√ß?)
2. **Aks ve ƒ∞letim:** (Aks sapmasƒ±, PR aralƒ±ƒüƒ±, QT aralƒ±ƒüƒ±).
3. **Dal Bloklarƒ±:** (RBBB, LBBB veya hemiblok var mƒ±?)
4. **ƒ∞skemi ve Enfarkt√ºs:** (ST y√ºkselmesi/√ß√∂kmesi, T negatifliƒüi, Patolojik Q dalgasƒ±).
5. **Kritik Sendromlar & MI E≈üdeƒüerleri:** (√ñzellikle ≈üunlarƒ± kontrol et: Wellens Sendromu, De Winter T dalgalarƒ±, Sgarbossa Kriterleri, aVR'de ST y√ºkselmesi).
6. **Elektrolit ƒ∞mbalansƒ±:** (Hiperkalemi bulgusu var mƒ±?)

**√ñNEMLƒ∞:** Eƒüer hayati tehlike arz eden acil bir durum (STEMI, VT, VF, 3. derece blok, Ciddi Hiperkalemi vb.) varsa, raporun en ba≈üƒ±na "üö® **ACƒ∞L DURUM:**" etiketiyle b√ºy√ºk harflerle yaz.
Eƒüer g√∂r√ºnt√º EKG deƒüilse veya okunamƒ±yorsa bunu belirt.
Metni temiz, kƒ±sa ve maddeler halinde formatla.
            `;

            // Base64 ba≈ülƒ±ƒüƒ±nƒ± temizle (data:image/jpeg;base64, kƒ±smƒ±nƒ± at)
            const cleanBase64 = base64Image.split(',')[1];

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inline_data: { mime_type: "image/jpeg", data: cleanBase64 } }
                        ]
                    }]
                })
            });

            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.error?.message || "AI servisine ula≈üƒ±lamadƒ±.");
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        };

        // --- Ana Bile≈üen ---
        function App() {
            const [user, setUser] = useState(null);
            const [mode, setMode] = useState(null);
            const [roomCode, setRoomCode] = useState('');
            const [transferredFiles, setTransferredFiles] = useState([]);
            const [uploading, setUploading] = useState(false);
            const [inputCode, setInputCode] = useState('');
            const [statusMsg, setStatusMsg] = useState('');
            const [copied, setCopied] = useState(false);
            
            // AI Durumlarƒ±
            // G√úNCELLEME: API Anahtarƒ± varsayƒ±lan olarak eklendi
            const [geminiKey, setGeminiKey] = useState(localStorage.getItem('gemini_key') || 'AIzaSyAGaXGTyOyouEJPUKTlYlmEoXHgQlJpxYY');
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [aiResult, setAiResult] = useState(null);
            const [analyzingId, setAnalyzingId] = useState(null);
            const [showSettings, setShowSettings] = useState(false);

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.error("Auth init error:", err);
                        if (err.code === 'auth/api-key-not-valid-please-pass-a-valid-api-key') {
                           setStatusMsg("HATA: Firebase API Anahtarƒ± hatalƒ±! L√ºtfen index.html dosyasƒ±ndaki ayarlarƒ± kontrol edin.");
                        } else {
                           setStatusMsg("Baƒülantƒ± Hatasƒ±: " + err.message);
                        }
                    }
                };

                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => setUser(u));
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || mode !== 'receive' || !roomCode) return;
                
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'transfer_rooms', roomCode);
                setDoc(roomRef, { created: Date.now(), files: [] }, { merge: true });

                const unsubscribe = onSnapshot(roomRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.files && data.files.length > 0) {
                            const newFiles = data.files.reverse();
                            // Eƒüer yeni dosya geldiyse ve hen√ºz analiz edilmediyse otomatik analiz ba≈ülat
                            if (newFiles.length > transferredFiles.length && transferredFiles.length > 0 && geminiKey) {
                                // Otomatik analiz isteƒüe baƒülƒ±dƒ±r, burada manuel bƒ±rakƒ±yoruz
                            }
                            setTransferredFiles(newFiles);
                        }
                    }
                });
                return () => unsubscribe();
            }, [user, mode, roomCode]);

            const startReceiving = () => {
                setRoomCode(generateRoomCode());
                setMode('receive');
                setTransferredFiles([]);
                setAiResult(null);
            };

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (!inputCode || inputCode.length !== 6) {
                    setStatusMsg("L√ºtfen ge√ßerli bir kod girin.");
                    return;
                }

                setUploading(true);
                setStatusMsg("EKG g√∂nderiliyor...");

                try {
                    let fileData = await compressImage(file);
                    
                    const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'transfer_rooms', inputCode);
                    const docSnap = await getDoc(roomRef);
                    
                    if (!docSnap.exists()) {
                        setStatusMsg("Kod hatalƒ± veya oturum kapalƒ±.");
                        setUploading(false);
                        return;
                    }

                    await updateDoc(roomRef, {
                        files: arrayUnion({
                            id: Date.now().toString(),
                            name: "EKG_" + new Date().toLocaleTimeString(),
                            type: file.type,
                            data: fileData,
                            timestamp: Date.now()
                        })
                    });

                    setStatusMsg("Ba≈üarƒ±yla g√∂nderildi! Ekrana bakƒ±nƒ±z.");
                    e.target.value = null;
                } catch (err) {
                    console.error(err);
                    setStatusMsg("Hata: " + err.message);
                } finally {
                    setUploading(false);
                    setTimeout(() => setStatusMsg(''), 3000);
                }
            };

            const runAnalysis = async (file) => {
                if (!geminiKey) {
                    setShowSettings(true);
                    return;
                }
                setIsAnalyzing(true);
                setAnalyzingId(file.id);
                setAiResult(null); // √ñnceki sonucu temizle

                try {
                    const result = await analyzeECGWithGemini(file.data, geminiKey);
                    setAiResult({ id: file.id, text: result });
                } catch (error) {
                    setAiResult({ id: file.id, text: "‚ùå Analiz Hatasƒ±: " + error.message });
                } finally {
                    setIsAnalyzing(false);
                    setAnalyzingId(null);
                }
            };

            const saveKey = () => {
                localStorage.setItem('gemini_key', geminiKey);
                setShowSettings(false);
            };

            const copyCode = () => {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(roomCode);
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                }
            };

            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 text-center">
                        <div className="flex flex-col items-center">
                            <Icons.HeartPulse className="w-12 h-12 text-red-500 animate-pulse mb-4" />
                            <p>Sistem Hazƒ±rlanƒ±yor...</p>
                        </div>
                    </div>
                );
            }

            if (!mode) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4 relative overflow-hidden">
                        {/* Arkaplan EKG Efekti */}
                        <div className="absolute inset-0 opacity-10 pointer-events-none flex items-center justify-center">
                            <svg viewBox="0 0 500 150" className="w-full text-red-500 stroke-current" fill="none" strokeWidth="2">
                                <path d="M0,75 L50,75 L60,40 L70,110 L80,75 L120,75 L130,20 L140,130 L150,75 L200,75 L210,50 L220,100 L230,75 L500,75" />
                            </svg>
                        </div>

                        <div className="max-w-md w-full bg-slate-900/80 backdrop-blur-md rounded-2xl shadow-2xl border border-slate-700 p-8 text-center fade-in relative z-10">
                            <div className="w-20 h-20 bg-red-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg shadow-red-500/30 pulse-red">
                                <Icons.Activity className="w-10 h-10 text-white" />
                            </div>
                            <h1 className="text-3xl font-bold mb-2 bg-gradient-to-r from-red-400 to-red-600 bg-clip-text text-transparent">AI EKG Asistanƒ±</h1>
                            <p className="text-slate-400 mb-8 text-sm">Acil Servis & Kardiyoloji Hƒ±zlƒ± Karar Destek Sistemi</p>
                            
                            <div className="space-y-4">
                                <button onClick={startReceiving} className="w-full flex items-center gap-4 p-4 bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-red-500/50 rounded-xl transition-all group">
                                    <div className="p-3 bg-red-500/10 rounded-lg text-red-400 group-hover:text-red-300">
                                        <Icons.Monitor className="w-6 h-6" />
                                    </div>
                                    <div className="text-left">
                                        <div className="font-semibold text-lg">Doktor Ekranƒ±</div>
                                        <div className="text-xs text-slate-400">G√∂r√ºnt√ºle ve AI Analizi Yap</div>
                                    </div>
                                </button>

                                <button onClick={() => setMode('send')} className="w-full flex items-center gap-4 p-4 bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-blue-500/50 rounded-xl transition-all group">
                                    <div className="p-3 bg-blue-500/10 rounded-lg text-blue-400 group-hover:text-blue-300">
                                        <Icons.Camera className="w-6 h-6" />
                                    </div>
                                    <div className="text-left">
                                        <div className="font-semibold text-lg">EKG Tarayƒ±cƒ±</div>
                                        <div className="text-xs text-slate-400">Mobil cihaz ile EKG √ßek</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- ALICI (DOKTOR) EKRANI ---
            if (mode === 'receive') {
                return (
                    <div className="min-h-screen p-4 fade-in flex flex-col h-screen">
                        {/* Header */}
                        <div className="flex items-center justify-between mb-6 px-4 py-3 bg-slate-800 rounded-xl border border-slate-700 shadow-lg">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-red-500/20 rounded-lg">
                                    <Icons.Activity className="w-6 h-6 text-red-400" />
                                </div>
                                <div>
                                    <h2 className="text-lg font-bold">EKG Konsolu</h2>
                                    <div className="text-xs text-slate-400 flex items-center gap-2">
                                        <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Canlƒ± Baƒülantƒ±
                                    </div>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <button onClick={() => setShowSettings(!showSettings)} className="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded-md transition-colors border border-slate-600">
                                    {geminiKey ? 'üîë API Anahtarƒ± Girildi' : '‚ö†Ô∏è API Anahtarƒ± Girin'}
                                </button>
                                <button onClick={() => setMode(null)} className="flex items-center gap-1 text-slate-400 hover:text-white px-3 py-1.5 hover:bg-slate-700 rounded-md transition-colors">
                                    <Icons.X className="w-4 h-4" /> √áƒ±kƒ±≈ü
                                </button>
                            </div>
                        </div>

                        {/* Settings Modal */}
                        {showSettings && (
                            <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                                <div className="bg-slate-800 p-6 rounded-xl border border-slate-600 w-full max-w-md shadow-2xl">
                                    <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
                                        <Icons.BrainCircuit className="w-5 h-5 text-purple-400" />
                                        Yapay Zeka Ayarlarƒ±
                                    </h3>
                                    <p className="text-sm text-slate-400 mb-4">
                                        EKG analizi i√ßin Google Gemini API anahtarƒ± gereklidir. Anahtar tarayƒ±cƒ±nƒ±zda yerel olarak saklanƒ±r.
                                    </p>
                                    <input 
                                        type="password" 
                                        value={geminiKey} 
                                        onChange={(e) => setGeminiKey(e.target.value)} 
                                        placeholder="AI Studio API Key (AIza...)"
                                        className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white mb-4 focus:border-purple-500 outline-none"
                                    />
                                    <div className="flex justify-end gap-2">
                                        <button onClick={() => setShowSettings(false)} className="px-4 py-2 text-slate-400 hover:text-white">ƒ∞ptal</button>
                                        <button onClick={saveKey} className="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg">Kaydet</button>
                                    </div>
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-xs text-blue-400 hover:underline block mt-4 text-center">Anahtar Al (Google AI Studio)</a>
                                </div>
                            </div>
                        )}

                        <div className="grid lg:grid-cols-12 gap-6 flex-1 overflow-hidden">
                            {/* Sol Panel: Baƒülantƒ± Bilgisi */}
                            <div className="lg:col-span-3 flex flex-col gap-4">
                                <div className="bg-slate-800 rounded-2xl p-6 border border-slate-700 shadow-lg text-center">
                                    <h3 className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Cihaz E≈üle≈ütirme Kodu</h3>
                                    <div className="text-5xl font-mono font-bold text-red-400 tracking-widest my-4 select-all drop-shadow-lg">
                                        {roomCode}
                                    </div>
                                    <p className="text-xs text-slate-500 mb-4">Mobil cihazdan bu kodu girin</p>
                                    <button onClick={copyCode} className="w-full py-2 flex items-center justify-center gap-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-colors">
                                        {copied ? <Icons.Check className="w-4 h-4 text-green-400" /> : <Icons.Copy className="w-4 h-4" />}
                                        {copied ? 'Kopyalandƒ±' : 'Kodu Kopyala'}
                                    </button>
                                </div>

                                <div className="flex-1 bg-slate-800 rounded-2xl p-4 border border-slate-700 overflow-y-auto">
                                    <h3 className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-4 border-b border-slate-700 pb-2">Ge√ßmi≈ü √áekimler</h3>
                                    <div className="space-y-2">
                                        {transferredFiles.map((f) => (
                                            <div 
                                                key={f.id} 
                                                onClick={() => {
                                                    setAiResult(null); // Listeden eskiye tƒ±klanƒ±nca sonucu sƒ±fƒ±rla
                                                }}
                                                className={`p-3 rounded-lg cursor-pointer transition-colors flex items-center gap-3 ${aiResult?.id === f.id ? 'bg-slate-700 border-l-4 border-purple-500' : 'bg-slate-900 hover:bg-slate-700'}`}
                                            >
                                                <img src={f.data} className="w-10 h-10 object-cover rounded bg-black" />
                                                <div className="text-xs overflow-hidden">
                                                    <div className="font-bold truncate">{f.name}</div>
                                                    <div className="text-slate-500">{new Date(f.timestamp).toLocaleTimeString()}</div>
                                                </div>
                                            </div>
                                        ))}
                                        {transferredFiles.length === 0 && <div className="text-center text-slate-600 text-sm py-8">Hen√ºz EKG gelmedi.</div>}
                                    </div>
                                </div>
                            </div>

                            {/* Orta & Saƒü Panel: G√∂r√ºnt√º ve Analiz */}
                            <div className="lg:col-span-9 flex gap-6 h-full overflow-hidden">
                                {transferredFiles.length > 0 ? (
                                    <>
                                        {/* G√∂r√ºnt√º Alanƒ± */}
                                        <div className="flex-1 bg-black rounded-2xl border border-slate-700 relative flex flex-col overflow-hidden">
                                            <div className="flex-1 flex items-center justify-center p-4 bg-[url('https://www.transparenttextures.com/patterns/grid-me.png')]">
                                                <img src={transferredFiles[0].data} className="max-w-full max-h-full object-contain shadow-2xl" alt="ECG" />
                                            </div>
                                            <div className="p-4 bg-slate-800 border-t border-slate-700 flex justify-between items-center">
                                                <div className="text-sm font-mono text-slate-300">
                                                    ID: {transferredFiles[0].id.slice(-6)}
                                                </div>
                                                <button 
                                                    onClick={() => runAnalysis(transferredFiles[0])}
                                                    disabled={isAnalyzing}
                                                    className={`px-6 py-2 rounded-lg font-bold text-white shadow-lg flex items-center gap-2 transition-all ${isAnalyzing ? 'bg-slate-600 cursor-not-allowed' : 'bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 hover:shadow-purple-500/25'}`}
                                                >
                                                    {isAnalyzing ? (
                                                        <><Icons.BrainCircuit className="w-5 h-5 animate-spin" /> Analiz Ediliyor...</>
                                                    ) : (
                                                        <><Icons.BrainCircuit className="w-5 h-5" /> Yapay Zeka ile Yorumla</>
                                                    )}
                                                </button>
                                            </div>
                                        </div>

                                        {/* Analiz Sonu√ß Alanƒ± */}
                                        {aiResult && aiResult.id === transferredFiles[0].id && (
                                            <div className="w-1/3 bg-slate-800 rounded-2xl border border-slate-700 flex flex-col shadow-2xl animate-in slide-in-from-right duration-500">
                                                <div className="p-4 border-b border-slate-700 bg-slate-900/50 rounded-t-2xl flex items-center justify-between">
                                                    <h3 className="font-bold text-purple-400 flex items-center gap-2">
                                                        <Icons.Activity className="w-5 h-5" /> AI Kardiyolog Raporu
                                                    </h3>
                                                    <span className="text-xs bg-purple-900/50 text-purple-300 px-2 py-1 rounded">Gemini 1.5 Flash</span>
                                                </div>
                                                <div className="flex-1 p-6 overflow-y-auto prose prose-invert prose-sm max-w-none custom-scrollbar">
                                                    <div dangerouslySetInnerHTML={{ __html: marked.parse(aiResult.text) }} />
                                                    
                                                    <div className="mt-8 pt-4 border-t border-slate-700 text-xs text-slate-500 italic">
                                                        * Bu analiz bir yapay zeka tarafƒ±ndan √ºretilmi≈ütir ve kesin tƒ±bbi tanƒ± yerine ge√ßmez. L√ºtfen klinik bulgularla korele ediniz.
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </>
                                ) : (
                                    <div className="flex-1 bg-slate-800/50 border-2 border-dashed border-slate-700 rounded-2xl flex flex-col items-center justify-center text-slate-500">
                                        <div className="w-24 h-24 bg-slate-800 rounded-full flex items-center justify-center mb-6 animate-pulse">
                                            <Icons.Activity className="w-12 h-12 text-slate-600" />
                                        </div>
                                        <p className="text-xl font-medium mb-2">Sinyal Bekleniyor...</p>
                                        <p className="text-sm">Mobil cihazdan EKG taramasƒ± yapƒ±n</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // --- G√ñNDERƒ∞Cƒ∞ (MOBƒ∞L) EKRANI ---
            if (mode === 'send') {
                return (
                    <div className="min-h-screen flex flex-col fade-in bg-black">
                        <div className="p-4 flex items-center justify-between bg-slate-900 border-b border-slate-800">
                            <h2 className="text-lg font-bold flex items-center gap-2 text-blue-400"><Icons.Camera className="w-5 h-5" /> EKG Tarayƒ±cƒ±</h2>
                            <button onClick={() => setMode(null)} className="text-slate-400 hover:text-white"><Icons.X className="w-6 h-6" /></button>
                        </div>
                        <div className="flex-1 p-6 flex flex-col items-center justify-center w-full max-w-md mx-auto">
                            <div className="w-full mb-8">
                                <label className="block text-sm font-medium text-slate-400 mb-2 text-center uppercase tracking-wide">E≈üle≈ütirme Kodu</label>
                                <input type="number" placeholder="000000" value={inputCode} onChange={(e) => setInputCode(e.target.value)} className="w-full bg-slate-800 border-2 border-slate-700 focus:border-blue-500 rounded-xl px-4 py-4 text-center text-3xl tracking-[0.5em] font-mono text-white outline-none transition-all placeholder:tracking-normal placeholder:text-slate-600" />
                            </div>
                            
                            <label className={`relative w-full aspect-[4/3] rounded-3xl border-2 border-dashed flex flex-col items-center justify-center gap-4 cursor-pointer transition-all overflow-hidden ${uploading ? 'bg-slate-900 border-slate-700' : 'bg-slate-900 border-slate-600 hover:border-blue-500'}`}>
                                <input type="file" accept="image/*" capture="environment" onChange={handleFileUpload} disabled={uploading} className="hidden" />
                                {uploading ? (
                                    <div className="flex flex-col items-center">
                                        <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                                        <span className="text-blue-400 font-medium animate-pulse">Analiz Merkezine G√∂nderiliyor...</span>
                                    </div>
                                ) : (
                                    <>
                                        <div className="absolute inset-0 grid grid-cols-6 grid-rows-4 pointer-events-none opacity-20">
                                            {[...Array(24)].map((_, i) => <div key={i} className="border border-slate-500"></div>)}
                                        </div>
                                        <div className="w-20 h-20 bg-blue-600 rounded-full flex items-center justify-center shadow-lg shadow-blue-500/50 z-10 hover:scale-105 transition-transform">
                                            <Icons.Camera className="w-10 h-10 text-white" />
                                        </div>
                                        <div className="text-center z-10">
                                            <span className="block text-xl font-bold text-white mb-1">EKG'yi √áek</span>
                                            <span className="text-sm text-slate-400 bg-black/50 px-2 py-1 rounded">Net ve ƒ±≈üƒ±klƒ± √ßekin</span>
                                        </div>
                                    </>
                                )}
                            </label>

                            {statusMsg && <div className={`mt-6 px-4 py-3 rounded-lg text-sm text-center font-bold w-full animate-in slide-in-from-bottom-2 ${statusMsg.includes('Hata') ? 'bg-red-500/20 text-red-400 border border-red-500/50' : 'bg-green-500/20 text-green-400 border border-green-500/50'}`}>{statusMsg}</div>}
                        </div>
                    </div>
                );
            }
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
