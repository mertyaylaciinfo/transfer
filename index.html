<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hızlı Dosya Transferi</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel (JSX Derleyicisi) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map: React ve Firebase Modülleri -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>

    <style>
        /* Mobil ve masaüstü için ek stiller */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, getDoc } from 'firebase/firestore';

        // --- İkonlar (Lucide SVG'leri) ---
        const Icons = {
            Camera: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            Monitor: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></svg>,
            Upload: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Download: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            RefreshCw: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
            Smartphone: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></svg>,
            Image: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
            X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Copy: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            Check: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        };

        // --- Firebase Ayarları ---
        // NOT: Bu dosyayı kendi sitenizde yayınlayacaksanız, Firebase Console'dan alacağınız 
        // kendi yapılandırma ayarlarınızı aşağıdaki 'else' bloğuna eklemelisiniz.
        
        let firebaseConfig;
        let appId;

        if (typeof __firebase_config !== 'undefined') {
            // Canvas önizleme ortamı
            firebaseConfig = JSON.parse(__firebase_config);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        } else {
            // YAYINLAMA MODU: Burayı kendi proje bilgilerinizle doldurun
            firebaseConfig = {
                apiKey: "API_KEY_BURAYA",
                authDomain: "PROJE_ID.firebaseapp.com",
                projectId: "PROJE_ID",
                storageBucket: "PROJE_ID.firebasestorage.app",
                messagingSenderId: "SENDER_ID",
                appId: "APP_ID"
            };
            appId = "my-transfer-app";
        }

        // Uygulamayı Başlat
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Yardımcı Fonksiyonlar ---
        const generateRoomCode = () => Math.floor(100000 + Math.random() * 900000).toString();

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        const maxSize = 800;

                        if (width > height) {
                            if (width > maxSize) { height *= maxSize / width; width = maxSize; }
                        } else {
                            if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        };

        // --- Ana Bileşen ---
        function App() {
            const [user, setUser] = useState(null);
            const [mode, setMode] = useState(null);
            const [roomCode, setRoomCode] = useState('');
            const [transferredFiles, setTransferredFiles] = useState([]);
            const [uploading, setUploading] = useState(false);
            const [inputCode, setInputCode] = useState('');
            const [statusMsg, setStatusMsg] = useState('');
            const [copied, setCopied] = useState(false);

            useEffect(() => {
                signInAnonymously(auth).catch((err) => console.error("Auth error:", err));
                return onAuthStateChanged(auth, (u) => setUser(u));
            }, []);

            useEffect(() => {
                if (!user || mode !== 'receive' || !roomCode) return;
                
                // Firestore path: artifacts -> appId -> public -> data -> transfer_rooms -> roomCode
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'transfer_rooms', roomCode);

                setDoc(roomRef, { created: Date.now(), files: [] }, { merge: true });

                const unsubscribe = onSnapshot(roomRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.files && data.files.length > 0) {
                            setTransferredFiles(data.files.reverse());
                        }
                    }
                }, (error) => {
                    console.error("Snapshot error:", error);
                    setStatusMsg("Bağlantı hatası oluştu. Config ayarlarını kontrol edin.");
                });

                return () => unsubscribe();
            }, [user, mode, roomCode]);

            const startReceiving = () => {
                setRoomCode(generateRoomCode());
                setMode('receive');
                setTransferredFiles([]);
            };

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (!inputCode || inputCode.length !== 6) {
                    setStatusMsg("Lütfen geçerli bir 6 haneli kod girin.");
                    return;
                }

                setUploading(true);
                setStatusMsg("İşleniyor...");

                try {
                    let fileData = null;
                    if (file.type.startsWith('image/')) {
                        fileData = await compressImage(file);
                    } else {
                        if (file.size > 800 * 1024) throw new Error("Dosya çok büyük (Max 800KB).");
                        setStatusMsg("Şu an sadece resim/fotoğraf destekleniyor.");
                        setUploading(false);
                        return;
                    }

                    const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'transfer_rooms', inputCode);
                    const docSnap = await getDoc(roomRef);
                    
                    if (!docSnap.exists()) {
                        setStatusMsg("Bu kod ile aktif bir bağlantı bulunamadı.");
                        setUploading(false);
                        return;
                    }

                    await updateDoc(roomRef, {
                        files: arrayUnion({
                            id: Date.now().toString(),
                            name: file.name,
                            type: file.type,
                            data: fileData,
                            timestamp: Date.now()
                        })
                    });

                    setStatusMsg("Başarıyla gönderildi! ✅");
                    e.target.value = null;
                } catch (err) {
                    console.error(err);
                    setStatusMsg("Hata: " + err.message);
                } finally {
                    setUploading(false);
                    setTimeout(() => setStatusMsg(''), 3000);
                }
            };

            const copyCode = () => {
                const doCopy = () => {
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                };
                
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(roomCode).then(doCopy);
                } else {
                    const textArea = document.createElement("textarea");
                    textArea.value = roomCode;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand("copy");
                    document.body.removeChild(textArea);
                    doCopy();
                }
            };

            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="flex flex-col items-center animate-pulse">
                            <Icons.RefreshCw className="w-8 h-8 animate-spin mb-2" />
                            <p>Bağlanıyor...</p>
                        </div>
                    </div>
                );
            }

            if (!mode) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4">
                        <div className="max-w-md w-full bg-slate-800 rounded-2xl shadow-xl overflow-hidden border border-slate-700 p-8 text-center fade-in">
                            <div className="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-500/30">
                                <Icons.RefreshCw className="w-8 h-8 text-white" />
                            </div>
                            <h1 className="text-2xl font-bold mb-2">Dosya Transferi</h1>
                            <p className="text-slate-400 mb-8">Bir rol seçin</p>
                            
                            <div className="space-y-4">
                                <button onClick={startReceiving} className="w-full flex items-center gap-4 p-4 bg-slate-700 hover:bg-slate-600 rounded-xl transition-all group">
                                    <div className="p-2 bg-emerald-500/20 rounded-lg text-emerald-400">
                                        <Icons.Monitor className="w-6 h-6" />
                                    </div>
                                    <div className="text-left">
                                        <div className="font-semibold">Bilgisayar (Alıcı)</div>
                                        <div className="text-xs text-slate-400">Dosyaları al</div>
                                    </div>
                                </button>

                                <button onClick={() => setMode('send')} className="w-full flex items-center gap-4 p-4 bg-slate-700 hover:bg-slate-600 rounded-xl transition-all group">
                                    <div className="p-2 bg-blue-500/20 rounded-lg text-blue-400">
                                        <Icons.Smartphone className="w-6 h-6" />
                                    </div>
                                    <div className="text-left">
                                        <div className="font-semibold">Telefon (Gönderici)</div>
                                        <div className="text-xs text-slate-400">Fotoğraf gönder</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (mode === 'receive') {
                return (
                    <div className="min-h-screen p-4 fade-in">
                        <div className="max-w-4xl mx-auto">
                            <div className="flex items-center justify-between mb-8">
                                <button onClick={() => setMode(null)} className="flex items-center gap-2 text-slate-400 hover:text-white">
                                    <Icons.X className="w-5 h-5" /> Çıkış
                                </button>
                                <h2 className="text-xl font-bold flex items-center gap-2"><Icons.Monitor className="w-5 h-5 text-emerald-400" /> Alıcı</h2>
                            </div>

                            <div className="grid md:grid-cols-3 gap-6">
                                <div className="md:col-span-1">
                                    <div className="bg-slate-800 rounded-2xl p-6 border border-slate-700 sticky top-4">
                                        <h3 className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-4">Kod</h3>
                                        <div className="bg-slate-900 rounded-xl p-4 text-center mb-4 border border-slate-700 text-4xl font-mono font-bold text-emerald-400 tracking-widest select-all">
                                            {roomCode}
                                        </div>
                                        <button onClick={copyCode} className="w-full py-2 flex items-center justify-center gap-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-colors mb-4">
                                            {copied ? <Icons.Check className="w-4 h-4 text-emerald-400" /> : <Icons.Copy className="w-4 h-4" />}
                                            {copied ? 'Kopyalandı' : 'Kopyala'}
                                        </button>
                                        <p className="text-xs text-slate-500">Bu kodu telefonunuza girerek fotoğraf göndermeye başlayın.</p>
                                    </div>
                                </div>

                                <div className="md:col-span-2">
                                    <h3 className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-4 flex justify-between">
                                        Gelenler <span>{transferredFiles.length}</span>
                                    </h3>
                                    {transferredFiles.length === 0 ? (
                                        <div className="bg-slate-800/50 border border-dashed border-slate-700 rounded-2xl p-12 flex flex-col items-center justify-center text-slate-500">
                                            <Icons.Upload className="w-12 h-12 mb-4 opacity-50" />
                                            <p>Dosya bekleniyor...</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            {transferredFiles.map((file, idx) => (
                                                <div key={idx} className="bg-slate-800 rounded-xl overflow-hidden border border-slate-700 p-4 fade-in">
                                                    <div className="flex items-center justify-between mb-3">
                                                        <div className="flex items-center gap-2">
                                                            <Icons.Image className="w-4 h-4 text-emerald-400" />
                                                            <span className="text-sm font-medium">{file.name}</span>
                                                        </div>
                                                        <span className="text-xs text-slate-500">{new Date(file.timestamp).toLocaleTimeString()}</span>
                                                    </div>
                                                    <div className="relative group bg-slate-900 rounded-lg overflow-hidden flex justify-center">
                                                        <img src={file.data} alt="Gelen" className="max-h-64 object-contain" />
                                                        <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                                            <a href={file.data} download={`transfer_${file.id}.jpg`} className="bg-white text-slate-900 px-4 py-2 rounded-lg font-medium flex items-center gap-2 hover:bg-slate-200">
                                                                <Icons.Download className="w-4 h-4" /> İndir
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (mode === 'send') {
                return (
                    <div className="min-h-screen flex flex-col fade-in">
                        <div className="p-4 flex items-center justify-between bg-slate-800 border-b border-slate-700">
                            <h2 className="text-lg font-bold flex items-center gap-2"><Icons.Smartphone className="w-5 h-5 text-blue-400" /> Gönderici</h2>
                            <button onClick={() => setMode(null)} className="text-slate-400 hover:text-white"><Icons.X className="w-6 h-6" /></button>
                        </div>
                        <div className="flex-1 p-6 flex flex-col items-center justify-center max-w-md mx-auto w-full">
                            <div className="w-full mb-8">
                                <label className="block text-sm font-medium text-slate-400 mb-2">Bilgisayardaki Kod</label>
                                <input type="number" placeholder="000000" value={inputCode} onChange={(e) => setInputCode(e.target.value)} className="w-full bg-slate-800 border-2 border-slate-700 focus:border-blue-500 rounded-xl px-4 py-4 text-center text-2xl tracking-widest font-mono text-white outline-none" />
                            </div>
                            <label className={`relative w-full aspect-square max-h-64 rounded-3xl border-2 border-dashed flex flex-col items-center justify-center gap-4 cursor-pointer transition-all ${uploading ? 'bg-slate-800 opacity-50' : 'bg-slate-800 hover:border-blue-500'}`}>
                                <input type="file" accept="image/*" capture="environment" onChange={handleFileUpload} disabled={uploading} className="hidden" />
                                {uploading ? <Icons.RefreshCw className="w-12 h-12 text-blue-500 animate-spin" /> : <div className="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center shadow-lg"><Icons.Camera className="w-8 h-8 text-white" /></div>}
                                {!uploading && <div className="text-center"><span className="block text-lg font-medium">Fotoğraf Çek</span><span className="text-sm text-slate-500">veya seç</span></div>}
                            </label>
                            {statusMsg && <div className={`mt-6 px-4 py-3 rounded-lg text-sm text-center font-medium w-full ${statusMsg.includes('Hata') ? 'bg-red-500/10 text-red-400' : 'bg-emerald-500/10 text-emerald-400'}`}>{statusMsg}</div>}
                        </div>
                    </div>
                );
            }
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
